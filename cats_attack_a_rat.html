<!DOCTYPE html>
<!--
The MIT License (MIT)

Copyright (c) 2015 tjgoff

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->
<!-- 
Author: TJ Goff
Date: May 27, 2015
Version: 1.0

In the game Cats Attack A Rat, your goal is to guide the Rat, Brie, to stay
away from the cats, Willy, Whiskers, Wendy and Bob, for as long as possible.
Each cat has a distinct style of attack which will allow you to anticipate 
their behavior, and even manipulate them in order to keep a safe path open 
for escape.

The game is largely inspired by Pac Man, and has several references to the
original game.
-->
<html>
<head>
<style>
html,body {
    margin:0;
    padding:0;
    height:100%;
    overflow: hidden;
}
#wrapper {
    min-height:100%;
    position:relative;
}
#header {
    background:#ededed;
    padding:10px;
    text-align: center;
}
#startReset {
    margin-top:20%;
}
#clock, #startReset {
    margin-left: 45%;
    font-size: 30px;
}
#time_multiplier {
    margin-left: 45%;
}
.game {
    display: none;
    position:absolute;
}
</style>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

<script type="text/javascript">
var frameRate = 50, interval;
var corners, startTime;
var gameActive = false, pageLoaded = false;
var clock, seconds = 0, minutes = 0, hours = 0, t, timeMult = 1;

//The rat, Brie, follows the mouse pointer
var rat = {
    pos: [],
    speed : 8, //number of pixels rat can move per frame
    maxSpeed: 8,
    id: "ratPic",
    height: 20,
    width: 20,
    goal: [],
    updateGoal : function() {
       this.goal = [window.mouseX, window.mouseY];
       //adjust rat's speed to prevent overshooting goal
       this.speed = Math.min(this.maxSpeed, distance(this.pos, this.goal));
    }
};

//Cat1, Willy, goes straight for the rat, but slowly (chaser)
var cat1 = {
    pos: [],
    speed : 4, //pixels per frame
    goal: [],
    id: "cat1",
    img: "cat-orange.png",
    imgNear: "cat-orange-bite2.png",
    height: 46,
    width: 50,
    updateGoal : function() {
        this.goal =  rat.pos;
    }
};

//Cat2, Whiskers, goes to random places (wanderer)
var cat2 = {
    pos: [],
    speed : 8, //pixels per frame
    goal: [],
    id: "cat2",
    img: "cat-blue.png",
    imgNear: "cat-blue-bite2.png",
    height: 46,
    width: 50,
    updateGoal : function() {
        if( inRange( this.pos, this.goal, this.width) ) {
            this.goal = [Math.round(Math.random()*window.innerWidth), 
                         Math.round(Math.random()*window.innerHeight)];
        }
    }
};

//Cat3, Wendy, runs around the edges, and attacks when lined up with the rat (dasher)
var cat3 = {
    pos: [],
    speed : 11, //pixels per frame
    goal: [],
    id:"cat3",
    img: "cat-pink.png",
    imgNear: "cat-pink-bite2.png",
    height:46,
    width: 50,
    state: "CW", //toggles clockwise or counter-clockwise edge movement
    updateGoal : function() {
        if( inRange( this.pos, this.goal, this.width) ) {  //pick a corner for new goal
            if(this.pos[1] <= this.height && 
               this.pos[0] < window.innerWidth - this.width){ //top -> goal is top right
                this.goal = corners[1];
            } else if(this.pos[0] >= window.innerWidth - this.width && 
               this.pos[1] < window.innerHeight - this.height) { //right -> goal in bottom right
                this.goal = corners[2];
            } else if(this.pos[1] >= window.innerHeight - this.height &&
               this.pos[0] > this.width) { //bottom -> goal in bottom left
                this.goal = corners[3];
            } else if(this.pos[0] <= this.width &&
               this.pos[1] > this.height) { //left -> goal in top left
                this.goal = corners[0];
            }
        }
        //attack if rat is aligned orthogonally (only when near edge)
        if (this.pos[0]<=this.width || this.pos[0]>=window.innerWidth-this.width ||
            this.pos[1]<=this.height || this.pos[1]>=window.innerHeight-this.height) {
            if( Math.abs(this.pos[0]-rat.pos[0]) < rat.width ) { //vertical attack
                if( this.pos[1] <= this.height)
                    this.goal = [this.pos[0], corners[2][1]]; //downward
                else
                    this.goal = [this.pos[0], corners[0][1]]; //upward
                //TODO randomize CW/CCW
            } else if( Math.abs(this.pos[1]-rat.pos[1]) < rat.height ) { //horizontal attack
                if( this.pos[0] <= this.width)
                    this.goal = [corners[2][0], this.pos[1]];//rightward
                else
                    this.goal = [corners[0][0], this.pos[1]];//leftward
                //TODO randomize CW/CCW??
            }
        }
    }
};

//Cat4, Bob, is wants to move toward the rat, but avoids other cats (flanker)
var cat4 = {
    pos: [],
    speed : 6, //pixels per frame
    repulse: -60,//repulsive force from other cats
    goal: [],
    id: "cat4",
    img: "cat-yellow.png",
    imgNear: "cat-yellow-bite2.png",
    height: 46,
    width: 50,
    updateGoal : function() {
        //add up superposition forces from rat & cats
        //constant attractive force toward rat (doesn't scale with distance)
        var theta = Math.atan2(rat.pos[1] - this.pos[1], rat.pos[0] - this.pos[0]);
        this.goal[0] = this.pos[0] + Math.round( this.speed * Math.cos(theta) );
        this.goal[1] = this.pos[1] + Math.round( this.speed * Math.sin(theta) );  
        var distF;
        //add repulsive forces from other cats (large forces that drop with distance factor)
        for (var i=0; i < 3; i++) {
            theta = Math.atan2(cats[i].pos[1] - this.pos[1], cats[i].pos[0] - this.pos[0]);
            distF = Math.pow(distance(this.pos, cats[i].pos),0.6);
            if(distF != 0) {
                this.goal[0] += Math.round( this.repulse * Math.cos(theta) ) / distF;
                this.goal[1] += Math.round( this.repulse * Math.sin(theta) ) / distF;
            }            
        }
    }
};
//for looping over the cats
var cats = [cat1, cat2, cat3, cat4];

document.onmousemove = function(e) {
    var event = e || window.event;
    window.mouseX = event.clientX;
    window.mouseY = event.clientY;
}

function setClassDisplay(className, disp) {
    var x = document.getElementsByClassName(className);
    for (var i = 0; i < x.length; i++) {
        x[i].style.display = disp;
    }
}

function distance(p1, p2) {
    var x = p1[0] - p2[0];
    var y = p1[1] - p2[1];
    return Math.sqrt( (x*x) + (y*y) );
}

function inRange(pos1, pos2, dist) {
    return distance(pos1, pos2) <= dist;
}

function moveTowardGoal(mover) {
    var theta = Math.atan2(mover.goal[1] - mover.pos[1], mover.goal[0] - mover.pos[0]);
    mover.pos[0] += Math.round( mover.speed * timeMult * Math.cos(theta) );
    mover.pos[1] += Math.round( mover.speed * timeMult * Math.sin(theta) );
    document.getElementById(mover.id).style.marginLeft = mover.pos[0] - mover.width + "px";
    document.getElementById(mover.id).style.marginTop = mover.pos[1] - mover.height + "px";
}

//Update the game area
function updateGameState() {
    if(window.mouseX == undefined || window.mouseY == undefined || gameActive == false){
        return;
    }
    if(gameActive){
        //Move rat by max speed unless close to pointer/goal
        if (distance(rat.pos, [window.mouseX, window.mouseY]) > 2) {
            rat.updateGoal();
            moveTowardGoal(rat);
        }
        //each cat AI gets to update and move
        for(var i=0; i < cats.length; i++){
            cats[i].updateGoal();
            moveTowardGoal(cats[i]);
        }
    }
    //Check lose condition and update cat image if near rat
    for(var i=0; i < cats.length; i++){
        if( inRange(rat.pos, cats[i].pos, cats[i].width*1.1))
            endGame();
        if( inRange(rat.pos, cats[i].pos, cats[i].width*2.5))
            $('#'+cats[i].id).attr("src", cats[i].imgNear);
        else
            $('#'+cats[i].id).attr("src", cats[i].img);
    }
}

function addSec() {
    seconds++;
    if (seconds >= 60) {
        seconds = 0;
        minutes++;
        if (minutes >= 60) {
            minutes = 0;
            hours++;
        }
    }
    clock.textContent = (hours ? (hours > 9 ? hours : "0" + hours) : "00") + 
                        ":" + (minutes ? (minutes > 9 ? minutes : "0" + minutes) : "00") +
                        ":" + (seconds > 9 ? seconds : "0" + seconds);
    timer();
}
function timer() {
    t = setTimeout(addSec, 1000/timeMult);
}

function startGame() {
    if(!pageLoaded) {
        return;//the page must finish loading before game can start
    }
    timeMult = Number($('#timeMultiplier').val());
    interval = setInterval(updateGameState, 1000/(frameRate));
    gameActive = true;
    clock = document.getElementById('clock')
    clock.textContent = "00:00:00";
    seconds = 0; minutes = 0; hours = 0;
    timer();
    //reset game pieces
    rat.pos =  [window.innerWidth/2, window.innerHeight/2];
    cat1.pos = [corners[2][0], corners[2][1]];
    cat2.pos = [corners[0][0], corners[0][1]];
    cat2.goal = [corners[0][0], corners[0][1]];    
    cat3.pos = [corners[1][0], corners[1][1]];
    cat3.goal = [corners[2][0], corners[2][1]];
    cat4.pos = [corners[3][0], corners[3][1]];
    cat4.goal = [corners[3][0], corners[3][1]];
    
    setClassDisplay("game", "block");
    setClassDisplay("preGame", "none");
}

function endGame() {
    clearInterval(interval);
    gameActive = false;
    clearTimeout(t);
    //show non-game elements
    setClassDisplay("preGame", "block");
    //hide game elements
    setClassDisplay("game", "none");
}

window.onload = function() {
    //use loaded elements to get game dimensions
    rat.height = $('#ratPic').height()/2;
    rat.width = $('#ratPic').width()/2;
    cat1.height = cat2.height = cat3.height = $('#cat1').height()/2;
    cat1.width = cat2.width = cat3.width = $('#cat1').width()/2;
    corners = [ [cat3.width, cat3.height],
                [window.innerWidth-cat3.width, cat3.height],
                [window.innerWidth-cat3.width, window.innerHeight-cat3.height],
                [cat3.width, window.innerHeight-cat3.height] ];
    
    //Hide game elements until game starts
    setClassDisplay("game", "none");
    pageLoaded = true;
}
</script>
</head>

<body>

    <div id="wrapper">
        <div id="header" class="preGame">
            <h2 id="title">Cats Attack A Rat!</h2>
            <br />
            By TJ Goff, and made available under the <a rel="license" href="http://opensource.org/licenses/MIT">MIT License</a>.
        </div>
        
        <div id="content">
            <button id="startReset" class="preGame" type="button" onclick="startGame()">Start the game!</button>
            <div id="clock"><time>00:00:00</time></div>
            <div id="time_multiplier" class="preGame">
                Speed Control: 
                <select id="timeMultiplier">
                    <option value="0.75">Slow</option>
                    <option value="1" selected>Normal</option>
                    <option value="1.5">Fast</option>
                </select>
            </div>
            
            <img id="ratPic" class="game" src="mouse.png" width="40" height="40" style="z-index:5;">
            <img id="cat1" class="game" src="cat-orange.png" style="z-index:1;">
            <img id="cat2" class="game" src="cat-blue.png" style="z-index:2;">
            <img id="cat3" class="game" src="cat-pink.png" style="z-index:3;">
            <img id="cat4" class="game" src="cat-yellow.png" style="z-index:4;">
        </div>

    </div>


</body>
</html> 
